name: Update Google Scholar Stats

on:
  schedule:
    # Run every day at 03:17 UTC (less predictable time to avoid rate limiting)
    - cron: '17 3 * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - master
    paths:
      - '.github/workflows/update-scholar-stats.yml'
      - 'update-scholar-stats.py'

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to commit and push changes
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install scholarly beautifulsoup4 requests lxml
        
    - name: Update Scholar Stats
      id: update
      continue-on-error: true
      env:
        # Optional: Add ScraperAPI key if you have one (helps bypass 403 errors)
        # SCRAPER_API_KEY: ${{ secrets.SCRAPER_API_KEY }}
        PYTHONUNBUFFERED: 1
      run: |
        echo "🔄 Fetching stats at $(date)"
        python update-scholar-stats.py
        echo "update_status=$?" >> $GITHUB_OUTPUT
        
    - name: Check for changes
      id: git-check
      if: steps.update.outcome == 'success'
      run: |
        if git diff --quiet scholar-stats.json; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "ℹ️ No changes detected in scholar-stats.json"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "📝 Changes detected in scholar-stats.json"
        fi
        
    - name: Commit and push if changed
      if: steps.git-check.outputs.changed == 'true'
      run: |
        git config --local user.name 'github-actions[bot]'
        git config --local user.email 'github-actions[bot]@users.noreply.github.com'
        git add scholar-stats.json
        COMMIT_MSG="📊 Update Google Scholar statistics [automated]"
        COMMIT_MSG="${COMMIT_MSG}\n\nUpdated at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        COMMIT_MSG="${COMMIT_MSG}\nTriggered by: ${{ github.event_name }}"
        git commit -m "${COMMIT_MSG}"
        git push
        echo "✅ Changes committed and pushed successfully!"
        
    - name: Display current stats
      if: always()
      run: |
        echo ""
        echo "════════════════════════════════════════════════════"
        echo "📊 Current Scholar Statistics"
        echo "════════════════════════════════════════════════════"
        if [ -f scholar-stats.json ]; then
          cat scholar-stats.json
        else
          echo "⚠️ scholar-stats.json not found"
        fi
        echo "════════════════════════════════════════════════════"
        echo ""
        
    - name: Workflow Summary
      if: always()
      run: |
        echo "## 📊 Scholar Stats Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow Run:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.update.outcome }}" == "success" ]; then
          echo "✅ **Update Status:** Success - New data fetched" >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️ **Update Status:** Failed to fetch new data" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Google Scholar often blocks automated requests from GitHub Actions (403 Forbidden)." >> $GITHUB_STEP_SUMMARY
          echo "This is expected behavior. The website continues to use existing data." >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f scholar-stats.json ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Current Statistics (Displayed on Website)" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat scholar-stats.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "💡 **Tip:** If updates consistently fail, consider:" >> $GITHUB_STEP_SUMMARY
        echo "- Running the script locally and committing the updated \`scholar-stats.json\`" >> $GITHUB_STEP_SUMMARY
        echo "- Using a third-party API service (e.g., ScraperAPI) for more reliable access" >> $GITHUB_STEP_SUMMARY
